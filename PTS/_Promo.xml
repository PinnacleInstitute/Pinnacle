<WTROOT prefix="pts" dbo="dbo" system="Pinnacle">
	<WTENTITY id="154" name="Promo" alias="prm" log="false">

		<!--Identity-->
		<WTATTRIBUTE id="15401" name="PromoID" type="number" identity="true" min="1" required="true" source="entity"/>

		<!--Foreign Keys-->
		<WTATTRIBUTE id="15402" name="MerchantID" type="number" min="1" source="entity"/>
		<WTATTRIBUTE id="15403" name="CountryID" type="number" source="entity" required="true"/>

		<!--Foreign Table Fields-->

		<!--Attributes-->
		<WTATTRIBUTE id="15405" name="PromoName" type="text" length="60" min="1" max="60" required="true" title="true" source="entity"/>
		<WTATTRIBUTE id="15406" name="FromEmail" type="text" length="60" min="1" max="60" source="entity" required="true"/>
		<WTATTRIBUTE id="15407" name="Subject" type="text" length="80" min="1" max="80" source="entity" required="true"/>
		<WTATTRIBUTE id="15408" name="Message" type="text" length="200" min="1" max="200" source="entity"/>
		<WTATTRIBUTE id="15409" name="Status" type="number" source="entity">
			<WTENUM id="1" name="Compose"/>
			<WTENUM id="2" name="Ready"/>
			<WTENUM id="3" name="Sent"/>
			<WTENUM id="4" name="Cancelled"/>
		</WTATTRIBUTE>
    <WTATTRIBUTE id="15410" name="TargetArea" type="number" source="entity">
      <WTENUM id="1" name="Zip"/>
      <WTENUM id="2" name="City"/>
      <WTENUM id="3" name="State"/>
    </WTATTRIBUTE>
    <WTATTRIBUTE id="15411" name="TargetType" type="number" source="entity">
      <WTENUM id="1" name="TargetType1"/>
      <WTENUM id="2" name="TargetType2"/>
      <WTENUM id="3" name="TargetType3"/>
      <WTENUM id="4" name="TargetType4"/>
      <WTENUM id="5" name="TargetType5"/>
    </WTATTRIBUTE>
    <WTATTRIBUTE id="15412" name="TargetDays" type="number" source="entity"/>
    <WTATTRIBUTE id="15413" name="Target" type="text" length="200" min="1" max="200" source="entity"/>
		<WTATTRIBUTE id="15414" name="StartDate" type="date" source="entity">
			<WTFORMAT value="m-d-yy h:mm am/pm"/>
		</WTATTRIBUTE>
		<WTATTRIBUTE id="15415" name="EndDate" type="date" source="entity">
			<WTFORMAT value="m-d-yy h:mm am/pm"/>
		</WTATTRIBUTE>
		<WTATTRIBUTE id="15416" name="SendDate" type="date" source="entity"/>
		<WTATTRIBUTE id="15417" name="Msgs" type="number" source="entity"/>
		<WTATTRIBUTE id="15418" name="TestEmail" type="text" length="80" source="entity"/>

		<!--Indexes-->
		<WTINDEX name="MerchantID">
			<WTATTRIBUTE name="MerchantID"/>
		</WTINDEX>

		<!--Relationships-->
		<WTRELATIONSHIPS>
			<WTRELATIONSHIP name="Promo" entity="Promo" alias="prm"/>
			<WTRELATIONSHIP name="Common" entity="Promo" alias="prm"/>
		</WTRELATIONSHIPS>
		
		<WTENUM id="1" type="find">
			<WTATTRIBUTE name="PromoName" default="true" contains="true"/>
			<WTATTRIBUTE name="SendDate"/>
			<WTATTRIBUTE name="Status"/>
		</WTENUM>

		<!-- System Constants --> 
		<WTSYSCONS>
			<WTSYSCON name="PROMO-COMPOSE" value="1"/>
			<WTSYSCON name="PROMO-READY" value="2"/>
			<WTSYSCON name="PROMO-SENT" value="3"/>
			<WTSYSCON name="PROMO-CANCELLED" value="4"/>
		</WTSYSCONS>

	</WTENTITY>

	<WTPROCEDURES>
		<!--==================================================================================================================-->
		<WTPROCEDURE type="Add" name="Add" style="GenerateDataProc.xsl"/>
		<!--==================================================================================================================-->
		<WTPROCEDURE type="Delete" name="Delete" style="GenerateDataProc.xsl"/>
		<!--==================================================================================================================-->
		<WTPROCEDURE type="Fetch" name="Fetch" style="GenerateDataProc.xsl">
			<WTJOIN name="Common"/>
		</WTPROCEDURE>
		<!--==========================================================================================-->
		<WTPROCEDURE type="Update" name="Update" style="GenerateDataProc.xsl"/>
		<!--================================================================================================-->
		<WTPROCEDURE type="Find" name="Find" style="GenerateDataProc.xsl">
			<WTBOOKMARK name=""/>
			<WTPARAM name="ATTR(MerchantID)" direction="input" required="false"/>
			<WTPARAM name="SYS(userid)" direction="input"/>
			<WTJOIN name="Common"/>
			<WTCONDITION expr="ATTR(Promo.MerchantID)" oper="equal" value="PARAM(MerchantID)" connector="and"/>
		</WTPROCEDURE>
	</WTPROCEDURES>

	<WTWEBPAGES>
		<!--==========================================================================================================-->
		<WTWEBPAGE name="15401" caption="Merchant Promotions" action="5" header="false" footer="false" navbar="false" wrapper="wrapper800"
				   aspstyle="GenerateWebASP.xsl" xslstyle="GenerateWebXSLList.xsl">
		<!--==========================================================================================================-->
			<WTPARAM name="SearchText" datatype="text"/>
			<WTPARAM name="FindTypeID" datatype="number"/>
			<WTPARAM name="Bookmark" datatype="text"/>
			<WTPARAM name="Direction" datatype="number"/>
      <WTPARAM name="MerchantID" datatype="number"/>
      <WTPARAM name="Popup" datatype="number"/>

      <WTINCLUDE name="2FA.asp"/>
      <WTCODEGROUP><WTCALLSUB name="Check2FAMerchant reqMerchantID"/></WTCODEGROUP>

			<WTSETATTRIBUTE name="PARAM(FindTypeID)" value="FINDID(SendDate)">
				<WTCONDITION expr="PARAM(FindTypeID)" oper="equal" value="CONST(0)"/>
			</WTSETATTRIBUTE>

			<WTACTION id="0" name="New" type="New">
				<WTSETATTRIBUTE name="PARAM(Bookmark)" value="CONST(&quot;&quot;)"/>
				<WTSETATTRIBUTE name="PARAM(Direction)" value="CONST(1)"/>
				<WTOBJECT name="Promos" project="ptsPromoUser" class="CPromos">
					<WTSETATTRIBUTE name="CONST(.FindTypeID)" value="PARAM(FindTypeID)"/>
					<WTMETHOD name="XML">
						<WTPARAM name="xmlPromos" direction="return" datatype="text"/>
						<WTPARAM name="Option" direction="input" value="CONST(14)"/>
					</WTMETHOD>
				</WTOBJECT>
				<WTOBJECT name="Bookmark" project="wtSystem" class="CBookmark"/>
			</WTACTION>

			<WTACTION id="3" name="Cancel" type="Cancel">
				<WTRETURN/>
			</WTACTION>

			<WTACTION id="5" name="Find" type="New">
				<WTSETATTRIBUTE name="PARAM(Bookmark)" value="CONST(&quot;&quot;)"/>
				<WTSETATTRIBUTE name="PARAM(Direction)" value="CONST(1)"/>
			</WTACTION>

			<WTACTION id="6" name="Previous" type="New">
				<WTSETATTRIBUTE name="PARAM(Direction)" value="CONST(2)"/>
			</WTACTION>

			<WTACTION id="7" name="Next" type="New">
				<WTSETATTRIBUTE name="PARAM(Direction)" value="CONST(1)"/>
			</WTACTION>

			<WTOBJECT name="Promos" project="ptsPromoUser" class="CPromos">
				<WTMETHOD name="Find">
					<WTPARAM name="reqBookmark" direction="return" datatype="text"/>
					<WTPARAM name="FindTypeID" direction="input" value="PARAM(FindTypeID)"/>
					<WTPARAM name="Bookmark" direction="input" value="PARAM(Bookmark)"/>
					<WTPARAM name="SearchText" direction="input" value="PARAM(SearchText)"/>
					<WTPARAM name="Direction" direction="input" value="PARAM(Direction)"/>
					<WTPARAM name="MerchantID" direction="input" value="PARAM(MerchantID)"/>				
					<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
				</WTMETHOD>
				<WTMETHOD name="XML">
					<WTPARAM name="xmlPromos" direction="return" datatype="text"/>
					<WTPARAM name="Option" direction="input" value="CONST(15)"/>
				</WTMETHOD>
			</WTOBJECT>
			<WTOBJECT name="Bookmark" project="wtSystem" class="CBookmark">
				<WTSETATTRIBUTE name="ATTR(LastBookmark)" value="PARAM(Bookmark)"/>
				<WTMETHOD name="XML">
					<WTPARAM name="xmlBookmark" direction="return" datatype="text"/>
				</WTMETHOD>
			</WTOBJECT>

	 		<!--************************************************************************-->
			<WTCONTENT>
				<WTCOLUMN width="800" align="left"/>

        <WTFUNCTION name="NewPromo()">
          var url, win, mid;
          mid = document.getElementById('MerchantID').value
          url = "15403.asp?merchantid=" + mid
          win = window.location = url + "&amp;returnurl=15401.asp?merchantid=" + mid;
        </WTFUNCTION>

        <WTROW>
          <WTHIDDEN name="MerchantID" value="PARAM(MerchantID)"/>
        </WTROW>

        <WTROW margin-bottom="12">
          <WTSTATIC col="1" label="Promotions" class="PageHeading" align="left"/>
				</WTROW>
				
				<WTROW margin-bottom="6">
					<WTSTATIC col="1" tag="SearchBy" class="ColumnHeader" align="center"/>
					<WTCOMBO col="1" value="ATTR(Promos.FindTypeID)" translate="true"/>
					<WTSTATIC col="1" tag="SearchFor" class="ColumnHeader"/>
					<WTTEXT col="1" value="ATTR(Bookmark.SearchText)" size="20" focus="true"/>
          <WTBUTTON col="1" action="5" value="CONST(View)" default="true"/>
          <WTBUTTON col="1" value="CONST(NewPromo)">
            <WTCLICK>NewPromo()</WTCLICK>
          </WTBUTTON>
          <WTBUTTON col="1" value="CONST(Close)">
            <WTCONDITION expr="PARAM(Popup)" oper="not-equal" value="CONST(0)"/>
            <WTCLICK>window.close()</WTCLICK>
          </WTBUTTON>
          <WTBUTTON col="1" merge="2" value="CONST(Home)" align="center">
            <WTCONDITION expr="PARAM(Popup)" oper="equal" value="CONST(0)"/>
            <WTCLICK>window.parent.ShowTab('TabDashboard',1)</WTCLICK>
          </WTBUTTON>
        </WTROW>

        <WTSTATIC  label="DuplicatePromo"/>

        <WTROW>
					<WTRECORDSET col="1" graybar="true" prevnext="top" entity="Promo">
						<WTCOLUMN width="50" align="left" valign="top" label="PromoName"/>
						<WTCOLUMN width="16" align="left" valign="top" label="Status"/>
						<WTCOLUMN width="18" align="left" valign="top" label="SendDate"/>
						<WTCOLUMN width="16" align="center" valign="top" label="Msgs"/>
						<WTROW height="24">
							<WTSTATIC col="1">
								<WTCODEGROUP>
									<WTSTATIC value="DATA(Promo.PromoName)" space="1"/>
									<WTIMAGE value="CONST(Edit.gif)" alt="Edit" imgalign="absmiddle">
										<WTLINK name="15403"><WTPARAM name="PromoID" value="DATA(PromoID)"/></WTLINK>
									</WTIMAGE>
									<WTSTATIC space="2"/>
									<WTIMAGE value="CONST(Copy.gif)" alt="DuplicatePromo" imgalign="absmiddle">
										<WTLINK name="15403">
											<WTPARAM name="MerchantID" value="PARAM(MerchantID)"/>
											<WTPARAM name="CopyID" value="DATA(PromoID)"/>
										</WTLINK>
									</WTIMAGE>
								</WTCODEGROUP>
							</WTSTATIC>
							<WTSTATIC col="2" value="DATA(Promo.Status)"/>
							<WTSTATIC col="3" value="DATA(Promo.SendDate)"/>
							<WTSTATIC col="4" value="DATA(Promo.Msgs)"/>
						</WTROW>
						<WTROW>
							<WTSTATIC col="1" merge="4" fontcolor="gray">
								<WTSTATIC space="5"/>
								<WTSTATIC tag="Target"/>
<!--                
								<WTSTATIC label="Zip">
									<WTCONDITION expr="DATA(TargetArea)" oper="equal" value="CONST(1)"/>
								</WTSTATIC>
								<WTSTATIC label="City">
									<WTCONDITION expr="DATA(TargetArea)" oper="equal" value="CONST(2)"/>
								</WTSTATIC>
								<WTSTATIC label="State">
									<WTCONDITION expr="DATA(TargetArea)" oper="equal" value="CONST(3)"/>
								</WTSTATIC>
								<WTSTATIC space="1"/>
-->
                <WTSTATIC value="DATA(Target)" space="1"/>
                <WTSTATIC value="DATA(TargetType)"/>
              </WTSTATIC>
						</WTROW>
					</WTRECORDSET>
				</WTROW>
			</WTCONTENT>
		</WTWEBPAGE>

 		<!--============================================================================================-->
		<WTWEBPAGE name="15403" caption="Merchant Promo" header="false" footer="false" navbar="false" wrapper="wrapper600"
				   aspstyle="GenerateWebASP.xsl" xslstyle="GenerateWebXSLItem.xsl">
 		<!--============================================================================================-->
			<WTPARAM name="PromoID" datatype="number"/>
			<WTPARAM name="MerchantID" datatype="number"/>
			<WTPARAM name="CompanyID" datatype="number"/>
			<WTPARAM name="CountryID" datatype="number"/>
			<WTPARAM name="CopyID" datatype="number"/>
      <WTPARAM name="SentPromo" datatype="number"/>
      <WTPARAM name="Target1" datatype="text"/>
      <WTPARAM name="Target2" datatype="text"/>
      <WTPARAM name="Target3" datatype="text"/>
      <WTPARAM name="Target4" datatype="text"/>
      <WTPARAM name="Target5" datatype="text"/>
      <WTPARAM name="Target6" datatype="text"/>
      <WTPARAM name="Target7" datatype="text"/>
      <WTPARAM name="Target8" datatype="text"/>
      <WTPARAM name="Target9" datatype="text"/>
      <WTPARAM name="Target10" datatype="text"/>
      <WTPARAM name="IsDemo" datatype="number"/>

      <WTINCLUDE name="Comm.asp"/>

			<WTCODEGROUP>
				<WTCONDITION expr="PARAM(CompanyID)" oper="equal" value="CONST(0)"/>
				<WTSETATTRIBUTE name="PARAM(CompanyID)" value="SYSCON(NEXXUS)"/>
			</WTCODEGROUP>

      <!-- **************************************************************************************************-->
      <WTSUB function="GetTarget(target)">
        <WTCODEGROUP>
          <WTCUSTOM>
            reqTarget1 = ""
            reqTarget2 = ""
            reqTarget3 = ""
            reqTarget4 = ""
            reqTarget5 = ""
            reqTarget6 = ""
            reqTarget7 = ""
            reqTarget8 = ""
            reqTarget9 = ""
            reqTarget10 = ""
            a = Split( target, ",")
            total = UBOUND(a)
            If total &gt;= 0 Then reqTarget1 = a(0)
            If total &gt;= 1 Then reqTarget2 = a(1)
            If total &gt;= 2 Then reqTarget3 = a(2)
            If total &gt;= 3 Then reqTarget4 = a(3)
            If total &gt;= 4 Then reqTarget5 = a(4)
            If total &gt;= 5 Then reqTarget6 = a(5)
            If total &gt;= 6 Then reqTarget7 = a(6)
            If total &gt;= 7 Then reqTarget8 = a(7)
            If total &gt;= 8 Then reqTarget9 = a(8)
            If total &gt;= 9 Then reqTarget10 = a(9)
          </WTCUSTOM>
        </WTCODEGROUP>
      </WTSUB>
      <WTSUB function="SetTarget">
        <WTCODEGROUP>
          <WTCUSTOM>
            target = ""
            x = 0
            While( x &lt; 10 )
              x = x + 1
              tmp = ""
              Select Case x
              Case 1 tmp = reqTarget1
              Case 2 tmp = reqTarget2
              Case 3 tmp = reqTarget3
              Case 4 tmp = reqTarget4
              Case 5 tmp = reqTarget5
              Case 6 tmp = reqTarget6
              Case 7 tmp = reqTarget7
              Case 8 tmp = reqTarget8
              Case 9 tmp = reqTarget9
              Case 10 tmp = reqTarget10
              End Select
              If tmp &lt;&gt; "" Then
                If target &lt;&gt; "" Then
                  target = target + "," + tmp
                Else
                  target = target + tmp
                End If
              End If
            Wend
            SetTarget = target
          </WTCUSTOM>
        </WTCODEGROUP>
      </WTSUB>

      <WTSUB name="LoadLists">
				<WTOBJECT name="Countrys" project="ptsCountryUser" class="CCountrys">
					<WTMETHOD name="EnumCompany">
						<WTPARAM name="xmlCountrys" direction="return" concat="true" datatype="text" />
						<WTPARAM name="CompanyID" direction="input" value="PARAM(CompanyID)" />
						<WTPARAM name="ItemID" direction="input" value="CONST()" />
						<WTPARAM name="Element" direction="input" value="CONST()" />
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)" />
					</WTMETHOD>
				</WTOBJECT>
			</WTSUB>

      <WTSUB name="CheckDemo">
        <WTOBJECT name="Merchant" project="ptsMerchantUser" class="CMerchant">
          <WTMETHOD name="Load">
            <WTPARAM name="MerchantID" direction="input" value="PARAM(MerchantID)"/>
            <WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
          </WTMETHOD>
          <WTSETATTRIBUTE name="PARAM(IsDemo)" value="CONST(1)">
            <WTCONDITION expr="ATTR(Status)" oper="equal" value="SYSCON(MERCHANT-STATUS-DEMO)"/>
          </WTSETATTRIBUTE>
        </WTOBJECT>
      </WTSUB>

      <WTSUB name="AddPromo">
				<WTCALLSUB name="LoadLists"/>
				<WTOBJECT name="Merchant" project="ptsMerchantUser" class="CMerchant">
					<WTCONDITION expr="PARAM(CopyID)" oper="equal" value="0"/>
					<WTMETHOD name="Load">
						<WTPARAM name="MerchantID" direction="input" value="PARAM(MerchantID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
          <WTSETATTRIBUTE name="PARAM(IsDemo)" value="CONST(1)">
            <WTCONDITION expr="ATTR(Status)" oper="equal" value="SYSCON(MERCHANT-STATUS-DEMO)"/>
          </WTSETATTRIBUTE>
          <WTSETATTRIBUTE name="CONST(tmpName)" value="ATTR(MerchantName)"/>
          <WTSETATTRIBUTE name="CONST(tmpFrom)" value="ATTR(Email)"/>
          <WTSETATTRIBUTE name="CONST(tmpFrom)" value="CONST(Chr(34) + tmpName + Chr(34) + &quot; &lt;&quot; + tmpFrom + &quot;&gt;&quot;)">
            <WTCONDITION expr="CONST(InStr(tmpFrom, Chr(34)))" oper="equal" value="0"/>
          </WTSETATTRIBUTE>
          <WTSETATTRIBUTE name="CONST(tmpSubject)" value="ATTR(MerchantName)"/>
					<WTSETATTRIBUTE name="CONST(tmpCountryID)" value="ATTR(CountryID)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetArea)" value="CONST(1)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetType)" value="CONST(1)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetDays)" value="CONST(30)"/>
          <WTSETATTRIBUTE name="CONST(tmpTarget)" value="ATTR(Zip)"/>
					<WTSETATTRIBUTE name="CONST(tmpTestEmail)" value="ATTR(Email)"/>
				</WTOBJECT>
        <WTCALLSUB name="CheckDemo">
          <WTCONDITION expr="PARAM(CopyID)" oper="not-equal" value="0"/>
        </WTCALLSUB>
        <WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
					<WTCONDITION expr="PARAM(CopyID)" oper="not-equal" value="0"/>
					<WTMETHOD name="Load">
						<WTPARAM name="PromoID" direction="input" value="PARAM(CopyID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
					<WTSETATTRIBUTE name="CONST(tmpName)" value="ATTR(PromoName)"/>
					<WTSETATTRIBUTE name="CONST(tmpFrom)" value="ATTR(FromEmail)"/>
					<WTSETATTRIBUTE name="CONST(tmpSubject)" value="ATTR(Subject)"/>
					<WTSETATTRIBUTE name="CONST(tmpMessage)" value="ATTR(Message)"/>
					<WTSETATTRIBUTE name="CONST(tmpCountryID)" value="ATTR(CountryID)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetArea)" value="ATTR(TargetArea)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetType)" value="ATTR(TargetType)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetDays)" value="ATTR(TargetDays)"/>
          <WTSETATTRIBUTE name="CONST(tmpTarget)" value="ATTR(Target)"/>
					<WTSETATTRIBUTE name="CONST(tmpTestEmail)" value="ATTR(TestEmail)"/>
				</WTOBJECT>
				<WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
					<WTMETHOD name="Load">
						<WTPARAM name="PromoID" direction="input" value="CONST(0)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
					<WTSETATTRIBUTE name="ATTR(MerchantID)" value="PARAM(MerchantID)"/>
					<WTSETATTRIBUTE name="ATTR(PromoName)" value="CONST(tmpName)"/>
					<WTSETATTRIBUTE name="ATTR(FromEmail)" value="CONST(tmpFrom)"/>
					<WTSETATTRIBUTE name="ATTR(Subject)" value="CONST(tmpSubject)"/>
					<WTSETATTRIBUTE name="ATTR(Message)" value="CONST(tmpMessage)"/>
					<WTSETATTRIBUTE name="ATTR(CountryID)" value="CONST(tmpCountryID)"/>
          <WTSETATTRIBUTE name="PARAM(CountryID)" value="ATTR(CountryID)"/>
          <WTSETATTRIBUTE name="ATTR(TargetArea)" value="CONST(tmpTargetArea)"/>
          <WTSETATTRIBUTE name="ATTR(TargetType)" value="CONST(tmpTargetType)"/>
          <WTSETATTRIBUTE name="ATTR(TargetDays)" value="CONST(tmpTargetDays)"/>
          <WTSETATTRIBUTE name="ATTR(Target)" value="CONST(tmpTarget)"/>
					<WTSETATTRIBUTE name="ATTR(SendDate)" value="SYS(Date)"/>
					<WTSETATTRIBUTE name="ATTR(TestEmail)" value="CONST(tmpTestEmail)"/>
					<WTSETATTRIBUTE name="ATTR(Status)" value="SYSCON(PROMO-COMPOSE)"/>
          <WTCALLSUB name="GetTarget(.Target)"/>
          <WTMETHOD name="Add">
						<WTPARAM name="reqPromoID" direction="return" datatype="number"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
					<WTMETHOD name="XML">
						<WTPARAM name="xmlPromo" direction="return" datatype="text"/>
						<WTPARAM name="Option" direction="input" value="CONST(2)"/>
					</WTMETHOD>
				</WTOBJECT>
			</WTSUB>

			<WTSUB name="LoadPromo">
				<WTCALLSUB name="LoadLists"/>
				<WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
					<WTMETHOD name="Load">
						<WTPARAM name="PromoID" direction="input" value="PARAM(PromoID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
          <WTCODEGROUP>
            <WTCONDITION expr="ATTR(Promo.Status)" oper="less-equal" value="2"/>
            <WTCALLSUB name="GetTarget(.Target)"/>
          </WTCODEGROUP>
          <WTSETATTRIBUTE name="PARAM(CountryID)" value="ATTR(Promo.CountryID)"/>
          <WTSETATTRIBUTE name="PARAM(MerchantID)" value="ATTR(Promo.MerchantID)">
						<WTCONDITION expr="PARAM(MerchantID)" oper="equal" value="0"/>
					</WTSETATTRIBUTE>
					<WTSETATTRIBUTE name="PARAM(SentPromo)" value="ATTR(Promo.Msgs)">
						<WTCONDITION expr="PARAM(SentPromo)" oper="greater" value="CONST(0)"/>
					</WTSETATTRIBUTE>
					<WTMETHOD name="XML">
						<WTPARAM name="xmlPromo" direction="return" datatype="text"/>
						<WTPARAM name="Option" direction="input" value="CONST(2)"/>
					</WTMETHOD>
				</WTOBJECT>
        <WTCALLSUB name="CheckDemo"/>
      </WTSUB>

			<WTSUB name="SavePromo">
        <WTSETATTRIBUTE name="CONST(tmpStatus)" value="FORM(Status)"/>
        <WTCODEGROUP>
          <WTCONDITION expr="CONST(tmpStatus)" oper="less-equal" value="2"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetArea)" value="FORM(TargetArea)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetType)" value="FORM(TargetType)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetDays)" value="FORM(TargetDays)"/>
          <WTSETATTRIBUTE name="CONST(tmpTarget)" value="CONST(SetTarget())"/>
          <WTSETATTRIBUTE name="CONST(tmpCountryID)" value="FORM(CountryID)"/>
          <WTOBJECT name="Consumer" project="ptsConsumerUser" class="CConsumer">
            <WTMETHOD name="CountEmail">
              <WTPARAM name="MerchantID" direction="input" value="PARAM(MerchantID)"/>
              <WTPARAM name="TargetArea" direction="input" value="CONST(tmpTargetArea)"/>
              <WTPARAM name="TargetType" direction="input" value="CONST(tmpTargetType)"/>
              <WTPARAM name="TargetDays" direction="input" value="CONST(tmpTargetDays)"/>
              <WTPARAM name="Target" direction="input" value="CONST(tmpTarget)"/>
              <WTPARAM name="CountryID" direction="input" value="CONST(tmpCountryID)"/>
              <WTPARAM name="tmpMsgs" direction="return" datatype="number"/>
            </WTMETHOD>
          </WTOBJECT>
        </WTCODEGROUP>
				<WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
					<WTMETHOD name="Load">
						<WTPARAM name="PromoID" direction="input" value="PARAM(PromoID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
          <WTCODEGROUP>
            <WTCONDITION expr="CONST(tmpStatus)" oper="less-equal" value="2"/>
            <WTSETATTRIBUTE name="ATTR(Msgs)" value="CONST(tmpMsgs)"/>
            <WTSETATTRIBUTE name="ATTR(Target)" value="CONST(tmpTarget)"/>
          </WTCODEGROUP>
					<WTSETATTRIBUTE name="PARAM(MerchantID)" value="ATTR(Promo.MerchantID)"/>
					<WTSETATTRIBUTES/>
          <WTMETHOD name="Save">
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
					<WTCODEGROUP>
						<WTCONDITION expr="IsErrors"/>
						<WTMETHOD name="XML">
							<WTPARAM name="xmlPromo" direction="return" datatype="text"/>
							<WTPARAM name="Option" direction="input" value="CONST(2)"/>
						</WTMETHOD>
						<WTCALLSUB name="LoadPromo"/>
					</WTCODEGROUP>
				</WTOBJECT>
			</WTSUB>

			<WTACTION id="0" name="New" type="New">
				<WTCALLSUB name="LoadPromo">
					<WTCONDITION expr="PARAM(PromoID)" oper="not-equal" value="0"/>
				</WTCALLSUB>
				<WTCALLSUB name="AddPromo">
					<WTCONDITION expr="PARAM(PromoID)" oper="equal" value="0"/>
				</WTCALLSUB>
				<WTCUSTOM>
					If reqSentPromo &lt;&gt; 0 Then DoError -1, "", reqSentPromo &amp; " promotions sent."
				</WTCUSTOM>
			</WTACTION>

			<WTACTION id="1" name="Update" type="Update">
				<WTCALLSUB name="SavePromo"/>
				<WTRETURN>
					<WTCONDITION expr="NoErrors"/>
				</WTRETURN>
			</WTACTION>

			<WTACTION id="3" name="Cancel" type="Cancel">
				<WTRETURN/>
			</WTACTION>

			<WTACTION id="4" name="Delete" type="Delete">
				<WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
					<WTMETHOD name="Delete">
						<WTPARAM name="PromoID" direction="input" value="PARAM(PromoID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
				</WTOBJECT>
				<WTCODEGROUP>
					<WTCONDITION expr="IsErrors"/>
					<WTCALLSUB name="LoadPromo"/>
				</WTCODEGROUP>
				<WTRETURN>
					<WTCONDITION expr="NoErrors"/>
				</WTRETURN>
			</WTACTION>

			<WTACTION id="5" name="TestPromo" type="Update">
				<WTSETATTRIBUTE name="CONST(tmpEmail)" value="FORM(TestEmail)"/>
        <WTCALLSUB name="SavePromo"/>
        <WTCODEGROUP>
					<WTCONDITION expr="CONST(tmpEmail)" oper="equal" value="CONST(&quot;&quot;)"/>
					<WTCALLSUB name="LoadPromo"/>
					<WTERROR number="10007" message="Please enter a test promotion email address."/>
				</WTCODEGROUP>
				<WTCODEGROUP>
					<WTCONDITION expr="CONST(tmpEmail)" oper="not-equal" value="CONST(&quot;&quot;)"/>
					<WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
						<WTMETHOD name="Load">
							<WTPARAM name="PromoID" direction="input" value="PARAM(PromoID)"/>
							<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
						</WTMETHOD>
						<WTMETHOD name="XML">
							<WTPARAM name="xmlPromo" direction="return" datatype="text"/>
							<WTPARAM name="Option" direction="input" value="CONST(2)"/>
						</WTMETHOD>
						<WTSETATTRIBUTE name="CONST(tmpTo)" value="CONST(tmpEmail)"/>
						<WTSETATTRIBUTE name="CONST(tmpFrom)" value="ATTR(FromEmail)"/>
						<WTSETATTRIBUTE name="CONST(tmpSender)" value="CONST(tmpFrom)"/>
						<WTCUSTOM>
							If InStr(tmpTo, "@") &gt; 0 Then
              If InStr(tmpFrom, "@") = 0 Then tmpFrom = tmpTo
              'tmpSubject = Replace( .Subject, "{firstname}", "Bill" )
              'tmpSubject = Replace( tmpSubject, "{lastname}", "Jones" )
              tmpSubject = "" 'Don't send subject in text message
              tmpBody = Replace( .Message, "{firstname}", "Bill" )
              tmpBody = Replace( tmpBody, "{lastname}", "Jones" )
              tmpBody = Replace( tmpBody, "{id}", "0" )
              tmpBody = Replace( tmpBody, "{email}", .TestEmail )

              SendEmail reqCompanyID, tmpSender, tmpFrom, tmpTo, "", "", tmpSubject, tmpBody
              End If
            </WTCUSTOM>
					</WTOBJECT>
				</WTCODEGROUP>
			</WTACTION>

			<WTACTION id="6" name="PreviewPromo" type="Update">
        <WTCALLSUB name="SavePromo"/>
        <WTRETURN>
					<WTCONDITION expr="NoErrors"/>
					<WTLINK name="15407" return="false">
						<WTPARAM name="PromoID" value="PARAM(PromoID)"/>
					</WTLINK>
				</WTRETURN>
			</WTACTION>

      <WTACTION id="7" name="SendPromo" type="Update">
        <WTCALLSUB name="SavePromo"/>
        <WTHTTP>
          <WTCONDITION expr="NoErrors"/>
          <WTLINK name="15406">
            <WTPARAM name="PromoID" value="PARAM(PromoID)"/>
          </WTLINK>
        </WTHTTP>
        <WTRETURN/>
      </WTACTION>

      <WTACTION id="8" name="Refresh" type="Update">
        <WTCALLSUB name="SavePromo"/>
        <WTCALLSUB name="LoadPromo"/>
      </WTACTION>

      <!--************************************************************************************-->
			<WTCONTENT>
				<WTCOLUMN width="100" align="right"/>
				<WTCOLUMN width="500" align="left"/>

        <WTFUNCTION name="SetTargetDays()">
          var typ = document.getElementById('TargetType').value;
          if( typ &lt;= 3 ) {
          document.getElementById('TargetDays').style.display = "none";
          document.getElementById('TargetDaysField').style.display = "none";
          }
          else {
          document.getElementById('TargetDays').style.display = "";
          document.getElementById('TargetDaysField').style.display = "";
          }
        </WTFUNCTION>

        <WTLOAD>
          SetTargetDays();
        </WTLOAD>

        <WTROW>
					<WTHIDDEN value="PARAM(PromoID)"/>
					<WTHIDDEN value="PARAM(CompanyID)"/>
					<WTHIDDEN value="PARAM(MerchantID)"/>
          <WTHIDDEN value="PARAM(CountryID)"/>
          <WTHIDDEN value="ATTR(Promo.TargetArea)"/>
        </WTROW>

				<WTROW>
					<WTSTATIC col="1" merge="2" tag="Promo" value="ATTR(Promo.PromoName)" class="PageHeading" align="left"/>
				</WTROW>
				<WTROW margin-bottom="6">
					<WTDIVIDER col="1" merge="2" align="left" height="1" color="SYS(headerdivider)"/>
				</WTROW>
				<WTROW margin-bottom="6">
					<WTSTATIC col="1" merge="2" label="PromoText" align="left" class="prompt"/>
				</WTROW>

				<WTROW margin-bottom="3">
					<WTSTATIC col="1" tag="PromoName"/>
					<WTTEXT col="2" value="ATTR(Promo.PromoName)" size="60"/>
				</WTROW>

        <WTCODEGROUP>
          <WTCONDITION expr="ATTR(Promo.Status)" oper="less-equal" value="CONST(2)"/>
          <WTROW>
            <WTSTATIC col="1" tag="Target"/>
            <WTSTATIC col="2">
              <WTCODEGROUP>
                <WTTEXT value="PARAM(Target1)" size="5"/>
                <WTTEXT value="PARAM(Target2)" size="5"/>
                <WTTEXT value="PARAM(Target3)" size="5"/>
                <WTTEXT value="PARAM(Target4)" size="5"/>
                <WTTEXT value="PARAM(Target5)" size="5"/>
              </WTCODEGROUP>>
            </WTSTATIC>
            <WTSTATIC col="2" tag="Msgs" value="ATTR(Promo.Msgs)"/>
          </WTROW>
          <WTROW margin-bottom="3">
            <WTSTATIC col="1"/>
            <WTSTATIC col="2">
              <WTCODEGROUP>
                <WTTEXT value="PARAM(Target6)" size="5"/>
                <WTTEXT value="PARAM(Target7)" size="5"/>
                <WTTEXT value="PARAM(Target8)" size="5"/>
                <WTTEXT value="PARAM(Target9)" size="5"/>
                <WTTEXT value="PARAM(Target10)" size="5"/>
              </WTCODEGROUP>>
            </WTSTATIC>
            <WTBUTTON col="2" action="8" value="CONST(CountMsgs)" btnclass="smbutton"/>
          </WTROW>
        </WTCODEGROUP>
        <WTROW margin-bottom="3">
          <WTCONDITION expr="ATTR(Promo.Status)" oper="greater" value="CONST(2)"/>
          <WTSTATIC col="1" tag="Target"/>
          <WTSTATIC col="2" value="ATTR(Promo.Target)" bold="true"/>
        </WTROW>
        <WTROW margin-bottom="3">
          <WTCONDITION expr="ATTR(Promo.Status)" oper="less-equal" value="CONST(2)"/>
          <WTSTATIC col="1" tag="TargetType"/>
          <WTCOMBO col="2" value="ATTR(Promo.TargetType)">
            <WTCHANGE>SetTargetDays();</WTCHANGE>
          </WTCOMBO>
          <WTTEXT col="2" value="ATTR(Promo.TargetDays)" size="2"/>
          <WTTEXT col="2" name="TargetDaysField" value="CONST(Days)" style="BORDER:none;background:transparent;" size="7" prespace="false"/>
        </WTROW>
        <WTROW margin-bottom="3">
					<WTSTATIC col="1" tag="FromEmail"/>
					<WTTEXT col="2" value="ATTR(Promo.FromEmail)" size="60"/>
				</WTROW>

        <WTROW>
          <WTHIDDEN value="ATTR(Promo.Subject)"/>
        </WTROW>
<!--        
				<WTROW margin-bottom="3">
					<WTSTATIC col="1" tag="Subject"/>
					<WTTEXT col="2" value="ATTR(Promo.Subject)" size="60"/>
				</WTROW>
        <WTROW margin-bottom="3">
					<WTSTATIC col="1" tag="StartDate"/>
					<WTTEXT col="2" value="ATTR(Promo.StartDate)"/>
					<WTSTATIC col="2" tag="EndDate"/>
					<WTTEXT col="2" value="ATTR(Promo.EndDate)" prespace="false"/>
				</WTROW>
-->
				<WTROW margin-top="6" margin-bottom="6">
					<WTDIVIDER col="1" merge="2" align="left" height="1" color="SYS(divider)"/>
				</WTROW>
				<WTROW margin-bottom="6">
					<WTSTATIC col="1" merge="2" label="MessageText" align="left" class="prompt"/>
				</WTROW>
				<WTROW margin-bottom="6">
					<WTMEMO col="1" merge="2" align="left" value="ATTR(Promo.Message)" cols="72" rows="4"/>
				</WTROW>
        <WTROW>
          <WTSTATIC col="1" tag="Status"/>
          <WTCOMBO col="2" value="ATTR(Promo.Status)">
            <WTOPTION id="1" label="Compose"/>
            <WTOPTION id="3" label="Sent"/>
            <WTOPTION id="4" label="Cancelled"/>
          </WTCOMBO>
          <!--          
          <WTSTATIC col="2" tag="SendDate"/>
					<WTTEXT col="2" value="ATTR(Promo.SendDate)" prespace="false"/>
-->
          <WTSTATIC col="2">
            <WTCONDITION expr="ATTR(Promo.Status)" oper="greater" value="CONST(2)"/>
            <WTSTATIC value="ATTR(Promo.Msgs)" space="1"/>
            <WTSTATIC label="MsgsSent"/>
          </WTSTATIC>
        </WTROW>

        <WTROW margin-top="6" margin-bottom="6">
					<WTDIVIDER col="1" merge="2" align="left" height="1" color="SYS(divider)"/>
				</WTROW>
				<WTROW margin-bottom="6">
					<WTSTATIC col="1" merge="2" label="PreviewText" align="left" class="prompt"/>
				</WTROW>
				<WTROW>
					<WTSTATIC col="1" tag="TestEmail"/>
					<WTTEXT col="2" value="ATTR(Promo.TestEmail)"/>
				</WTROW>

				<WTROW margin-top="12">
          <WTBUTTON col="1" merge="2" action="6" value="CONST(Preview)" align="center"/>
          <WTBUTTON col="1" merge="2" action="5" value="CONST(TestPromo)" msg="ConfirmPreview" align="center"/>
          <WTBUTTON col="1" merge="2" action="7" value="CONST(Send)" align="center" msg="ConfirmSend">
            <WTCONDITION expr="PARAM(IsDemo)" oper="equal" value="CONST(0)"/>
          </WTBUTTON>
          <WTBUTTON col="1" merge="2" value="CONST(Send)" align="center">
            <WTCONDITION expr="PARAM(IsDemo)" oper="not-equal" value="CONST(0)"/>
            <WTCLICK>alert('Disabled for Demo!');</WTCLICK>
          </WTBUTTON>
        </WTROW>
				<WTROW margin-bottom="12" margin-top="12">
					<WTBUTTON col="1" merge="2" action="1" value="CONST(Update)" align="center">
						<WTCONDITION expr="IsActive"/>
					</WTBUTTON>
					<WTBUTTON col="1" merge="2" action="3" value="CONST(Cancel)" align="center"/>
					<WTBUTTON col="1" merge="2" action="4" value="CONST(Delete)"  align="center" msg="ConfirmDelete"/>
				</WTROW>
			</WTCONTENT>
		</WTWEBPAGE>

		<!--==================================================================================================-->
		<WTWEBPAGE name="15405" type="mail" aspstyle="GenerateWebASPMail.xsl" xslstyle="GenerateWebXSLMail.xsl">
		<!--==================================================================================================-->
			<WTPARAM name="MailReturnURL" datatype="text"/>		<!--Required Parameter for Mail-->
			<WTPARAM name="PromoID" datatype="number"/>
			<WTPARAM name="MerchantID" datatype="number"/>
			<WTPARAM name="CompanyID" datatype="number"/>

			<WTCODEGROUP>
				<WTCONDITION expr="PARAM(CompanyID)" oper="equal" value="CONST(0)"/>
				<WTSETATTRIBUTE name="PARAM(CompanyID)" value="SYSCON(NEXXUS)"/>
			</WTCODEGROUP>
			<WTCODEGROUP>
				<WTCONDITION expr="PARAM(PromoID)" oper="equal" value="CONST(0)"/>
				<WTCUSTOM>Response.Redirect Replace(reqMailReturnURL, "%26", "&amp;")</WTCUSTOM>
			</WTCODEGROUP>

			<WTACTION id="0" name="New" type="New">
				<WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
					<WTMETHOD name="Load">
						<WTPARAM name="PromoID" direction="input" value="PARAM(PromoID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
					<WTSETATTRIBUTE name="PARAM(MerchantID)" value="ATTR(Promo.MerchantID)"/>
					<WTSETATTRIBUTE name="CONST(tmpFrom)" value="ATTR(Promo.FromEmail)"/>
					<WTSETATTRIBUTE name="CONST(tmpSubject)" value="ATTR(Promo.Subject)"/>
          <WTSETATTRIBUTE name="CONST(tmpBody)" value="ATTR(Promo.Message)"/>
          <WTSETATTRIBUTE name="CONST(tmpTo)" value="ATTR(Promo.TestEmail)"/>
					<WTSETATTRIBUTE name="CONST(tmpFirstName)" value="CONST(&quot;Bill&quot;)"/>
					<WTSETATTRIBUTE name="CONST(tmpLastName)" value="CONST(&quot;Smith&quot;)"/>
					<WTMETHOD name="XML">
						<WTPARAM name="xmlPromo" direction="return" datatype="text"/>
						<WTPARAM name="Option" direction="input" value="CONST(2)"/>
					</WTMETHOD>
				</WTOBJECT>
				<WTOBJECT name="Company" project="ptsCompanyUser" class="CCompany">
					<WTCONDITION expr="PARAM(CompanyID)" oper="not-equal" value="0"/>
					<WTMETHOD name="Load">
						<WTPARAM name="CompanyID" direction="input" value="PARAM(CompanyID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
					<WTSETATTRIBUTE name="CONST(tmpSender)" value="ATTR(Company.Email)"/>
				</WTOBJECT>

				<WTMAIL from="tmpFrom" to="tmpTo" subject="tmpSubject" sender="tmpSender">
					<WTPREMAIL>
<WTCUSTOM>
  tmpSubject = Replace( tmpSubject, "{firstname}", tmpFirstName )
  tmpSubject = Replace( tmpSubject, "{lastname}", tmpLastName )
  tmpBody = Replace( tmpBody, "{firstname}", tmpFirstName )
  tmpBody = Replace( tmpBody, "{lastname}", tmpLastName )
  tmpBody = Replace( tmpBody, "{id}", "0" )
  tmpBody = Replace( tmpBody, "{email}", tmpTo )
  tmpLink = "&lt;A href=""http://www.BlockMsg.info/b.asp?m=1&amp;c=0""&gt;BLOCK:&lt;/A&gt;"
  tmpBody = tmpBody + " " + tmpLink
</WTCUSTOM>
					</WTPREMAIL>
				</WTMAIL>
      </WTACTION>

	 		<!--************************************************************************************-->
			<WTCONTENT>
				<WTCOLUMN width="750" align="left"/>

				<WTROW margin-bottom="12">
					<WTSTATIC col="1" value="ATTR(Promo.Message)"/>
				</WTROW>

			</WTCONTENT>
		</WTWEBPAGE>
		
		<!--==================================================================================================-->
		<WTWEBPAGE name="15406" worker="true" aspstyle="GenerateWebASP.xsl">
		<!--==================================================================================================-->
			<WTPARAM name="PromoID" datatype="number"/>
			<WTPARAM name="MerchantID" datatype="number"/>
			<WTPARAM name="CompanyID" datatype="number"/>

			<WTCODEGROUP>
				<WTCONDITION expr="PARAM(PromoID)" oper="equal" value="CONST(0)"/>
				<WTCUSTOM>Response.Write "Missing PromoID"</WTCUSTOM>
			</WTCODEGROUP>
			<WTCODEGROUP>
				<WTCONDITION expr="PARAM(CompanyID)" oper="equal" value="CONST(0)"/>
				<WTSETATTRIBUTE name="PARAM(CompanyID)" value="SYSCON(NEXXUS)"/>
			</WTCODEGROUP>

			<WTACTION id="0" name="New" type="New">
				<WTCOMMENT>Insure that the first test for a valid email passes</WTCOMMENT>
				<WTSETATTRIBUTE name="CONST(tmpTo)" value="CONST(&quot;@&quot;)"/>
				<WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
					<WTMETHOD name="Load">
						<WTPARAM name="PromoID" direction="input" value="PARAM(PromoID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="CONST(1)"/>
					</WTMETHOD>
					<WTSETATTRIBUTE name="PARAM(MerchantID)" value="ATTR(Promo.MerchantID)"/>
					<WTSETATTRIBUTE name="CONST(tmpFrom)" value="ATTR(Promo.FromEmail)"/>
					<WTSETATTRIBUTE name="CONST(tmpSubject)" value="ATTR(Promo.Subject)"/>
					<WTSETATTRIBUTE name="CONST(tmpBody)" value="ATTR(Promo.Message)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetArea)" value="ATTR(Promo.TargetArea)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetType)" value="ATTR(Promo.TargetType)"/>
          <WTSETATTRIBUTE name="CONST(tmpTargetDays)" value="ATTR(Promo.TargetDays)"/>
          <WTSETATTRIBUTE name="CONST(tmpTarget)" value="ATTR(Promo.Target)"/>
					<WTSETATTRIBUTE name="CONST(tmpCountryID)" value="ATTR(Promo.CountryID)"/>
					<WTMETHOD name="XML">
						<WTPARAM name="xmlPromo" direction="return" datatype="text"/>
						<WTPARAM name="Option" direction="input" value="CONST(2)"/>
					</WTMETHOD>
				</WTOBJECT>
				<WTOBJECT name="Company" project="ptsCompanyUser" class="CCompany">
					<WTMETHOD name="Load">
						<WTPARAM name="CompanyID" direction="input" value="PARAM(CompanyID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
					<WTSETATTRIBUTE name="CONST(tmpSender)" value="ATTR(Company.Email)"/>
				</WTOBJECT>
				<WTCUSTOM>
					tmpMasterSubject = tmpSubject
					tmpMasterBody = tmpBody
					tmpCount = 0
					tmpLink = "&lt;A href=""http://www.BlockMsg.info/b.asp?m={m}&amp;c={c}""&gt;BLOCK:&lt;/A&gt;"
					tmpLink = Replace( tmpLink, "{m}", CStr(reqMerchantID) )

					If InStr(tmpFrom, "@")=0 Then tmpFrom = ""
					If tmpFrom &lt;&gt; "" Then
          Set oMail = server.CreateObject("CDO.Message")
          If oMail Is Nothing Then Response.Write "Unable to Create Object - CDO.Message"
          With oMail
          .Sender = tmpSender
          .From = tmpFrom
          End With

          Set oConsumers = server.CreateObject("ptsConsumerUser.CConsumers")
          If oConsumers Is Nothing Then
          DoError Err.Number, Err.Source, "Unable to Create Object - ptsConsumerUser.CConsumers"
          Else
          With oConsumers
          .SysCurrentLanguage = reqSysLanguage
          .ListEmail reqMerchantID, tmpTargetArea, tmpTargetType, tmpTargetDays, tmpTarget, tmpCountryID
          If (Err.Number &lt;&gt; 0) Then DoError Err.Number, Err.Source, Err.Description

                For Each oConsumer in oConsumers
                With oConsumer
                  tmpTo = .Email2
                  'tmpSubject = Replace( tmpMasterSubject, "{firstname}", .NameFirst )
                  'tmpSubject = Replace( tmpSubject, "{lastname}", .NameLast )
                  tmpSubject = "" 'Don't send subject in text message
                  tmpBody = Replace( tmpMasterBody, "{firstname}", .NameFirst )
                  tmpBody = Replace( tmpBody, "{lastname}", .NameLast )
                  tmpBody = Replace( tmpBody, "{id}", .ConsumerID )
                  tmpBody = Replace( tmpBody, "{email}", tmpTo )
                  tmpBody = tmpBody + " " + Replace( tmpLink, "{c}", .ConsumerID )
                End With
                If InStr(tmpTo, &quot;@&quot;) &gt; 0 Then
										tmpCount = tmpCount + 1
										With oMail
											.To = tmpTo
											.Subject = tmpSubject
											.HTMLBody = tmpBody
											.Send
										End With
									End If
								Next
							End With
						End If	
						Set oConsumers = Nothing
						Set oMail = Nothing
					End If
				</WTCUSTOM>
				
				<WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
					<WTMETHOD name="Load">
						<WTPARAM name="PromoID" direction="input" value="PARAM(PromoID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="CONST(1)"/>
					</WTMETHOD>
					<WTCODEGROUP>
						<WTCONDITION expr="ATTR(Status)" oper="equal" value="CONST(3)"/>
						<WTSETATTRIBUTE name="ATTR(Msgs)" value="CONST(.Msgs + tmpCount)"/>
					</WTCODEGROUP>
					<WTCODEGROUP>
						<WTCONDITION expr="ATTR(Status)" oper="less" value="CONST(3)"/>
						<WTSETATTRIBUTE name="ATTR(Status)" value="CONST(3)"/>
						<WTSETATTRIBUTE name="ATTR(Msgs)" value="CONST(tmpCount)"/>
					</WTCODEGROUP>
					<WTSETATTRIBUTE name="ATTR(SendDate)" value="SYS(Date)"/>
					<WTMETHOD name="Save">
						<WTPARAM name="SecurityToken" direction="input" value="CONST(1)"/>
					</WTMETHOD>
				</WTOBJECT>

			</WTACTION>

	 		<!--************************************************************************************-->
		</WTWEBPAGE>

		<!--==================================================================================================-->
		<WTWEBPAGE name="15407" type="Promo Preview" header="false" footer="false" navbar="false"
		 aspstyle="GenerateWebASP.xsl" xslstyle="GenerateWebXSLItem.xsl">
		<!--==================================================================================================-->
			<WTPARAM name="PromoID" datatype="number"/>
			<WTPARAM name="MerchantID" datatype="number"/>
			<WTPARAM name="CompanyID" datatype="number"/>

			<WTCODEGROUP>
				<WTCONDITION expr="PARAM(CompanyID)" oper="equal" value="CONST(0)"/>
				<WTSETATTRIBUTE name="PARAM(CompanyID)" value="SYSCON(NEXXUS)"/>
			</WTCODEGROUP>

			<WTACTION id="0" name="New" type="New">

				<WTOBJECT name="Promo" project="ptsPromoUser" class="CPromo">
					<WTMETHOD name="Load">
						<WTPARAM name="PromoID" direction="input" value="PARAM(PromoID)"/>
						<WTPARAM name="SecurityToken" direction="input" value="SYS(userid)"/>
					</WTMETHOD>
					<WTCUSTOM>
						'tmpSubject = Replace( .Subject, "{firstname}", "Bill" )
						'.Subject = Replace( tmpSubject, "{lastname}", "Jones" )
						tmpBody = Replace( .Message, "{firstname}", "Bill" )
						tmpBody = Replace( tmpBody, "{lastname}", "Jones" )
						tmpBody = Replace( tmpBody, "{id}", "0" )
						.Message = Replace( tmpBody, "{email}", .TestEmail )
					</WTCUSTOM>
					<WTMETHOD name="XML">
						<WTPARAM name="xmlPromo" direction="return" datatype="text"/>
						<WTPARAM name="Option" direction="input" value="CONST(2)"/>
					</WTMETHOD>
				</WTOBJECT>
			</WTACTION>

			<WTACTION id="1" name="Return" type="New">
				<WTRETURN>
					<WTLINK name="15403" skipreturn="true">
						<WTPARAM name="PromoID" value="PARAM(PromoID)"/>
					</WTLINK>
				</WTRETURN>
			</WTACTION>

	 		<!--************************************************************************************-->
			<WTCONTENT>
				<WTCOLUMN width="75" align="right"/>
				<WTCOLUMN width="675" align="left"/>

				<WTROW margin-top="12" margin-bottom="6">
					<WTSTATIC col="1" tag="From"/>
					<WTSTATIC col="2" value="ATTR(Promo.FromEmail)"/>
				</WTROW>
				<WTROW margin-bottom="6">
					<WTSTATIC col="1" tag="To"/>
					<WTSTATIC col="2" value="ATTR(Promo.TestEmail)"/>
				</WTROW>
<!--        
				<WTROW margin-bottom="12">
					<WTSTATIC col="1" tag="Subject"/>
					<WTSTATIC col="2" value="ATTR(Promo.Subject)" bold="true"/>
				</WTROW>
-->        
				<WTROW margin-bottom="6">
					<WTDIVIDER col="1" merge="2" align="left" height="1" color="SYS(headerdivider)"/>
				</WTROW>

				<WTROW margin-bottom="12">
					<WTSTATIC col="1" merge="2" value="ATTR(Promo.Message)" align="left"/>
				</WTROW>

				<WTROW margin-top="6" margin-bottom="12">
					<WTDIVIDER col="1" merge="2" align="left" height="1" color="SYS(headerdivider)"/>
				</WTROW>
				<WTROW margin-bottom="12">
					<WTBUTTON col="1" merge="2" action="1" value="CONST(Return)" align="center"/>
				</WTROW>

			</WTCONTENT>
		</WTWEBPAGE>

	</WTWEBPAGES>
</WTROOT>