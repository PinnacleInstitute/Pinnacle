EXEC [dbo].pts_CheckProc 'pts_PB_ConvertPayment'
GO

--declare @Result varchar(1000) EXEC pts_PB_ConvertPayment 7211, @Result output print @Result

CREATE PROCEDURE [dbo].pts_PB_ConvertPayment
   @PaymentID int ,
   @Result varchar(1000) OUTPUT
AS

SET NOCOUNT ON

DECLARE @SalesOrderID int, @ID int, @CompanyID int, @MemberID int, @Total money, @Purpose varchar(100), @PayDate datetime 
DECLARE @Amount money, @Amount1 money, @Amount2 money, @tmpAmount money, @ProductID int, @tmpPaymentID int, @tmpCode varchar(10), @cnt int

SET @Result = '0'
SET @CompanyID = 11
SET @Amount = 0
SET @Amount1 = 0
SET @Amount2 = 0
SET @tmpAmount = 0

SET @tmpPaymentID = @PaymentID
SET @PaymentID = -1
SELECT @PaymentID = ISNULL(PaymentID,0), @MemberID = OwnerID, @Purpose = Purpose, @PayDate = PayDate FROM Payment Where PaymentID = @tmpPaymentID AND OwnerType = 4 AND Status >= 1 AND Status <= 3

IF @PaymentID > 0
BEGIN
	IF @Purpose Like 'AUTO:%' EXEC pts_PB_ValidAutoShip @Purpose, @Purpose OUTPUT

	SET @cnt = 1
	WHILE @cnt > 0
	BEGIN
		SET @tmpCode = ''
		IF @cnt = 1 SET @tmpCode = '101'
		IF @cnt = 2 SET @tmpCode = '102'
		IF @cnt = 3 SET @tmpCode = '103'
		IF @cnt = 4 SET @tmpCode = '104'
		IF @cnt = 5 SET @tmpCode = '201'
		IF @cnt = 6 SET @tmpCode = '202'
		IF @cnt = 7 SET @tmpCode = '203'
		IF @cnt = 8 SET @tmpCode = '205'
		IF @cnt = 9 SET @tmpCode = '211'
		IF @cnt = 10 SET @tmpCode = '212'
		IF @cnt = 11 SET @tmpCode = '213'
		SET @cnt = @cnt + 1
		
		IF @tmpCode = ''
			SET @cnt = 0
		ELSE
		BEGIN
			IF CHARINDEX(@tmpCode, @Purpose) > 0 
			BEGIN 
				SELECT @tmpAmount = Price FROM Product WHERE CompanyID = @CompanyID AND Code = @tmpCode
				IF @tmpCode NOT IN ('104','205') SET @Amount1 = @tmpAmount ELSE SET @Amount2 = @tmpAmount
			END	
		END
	END

	SET @Amount = @Amount1 + @Amount2
	SET @Total = @Amount

-- SalesOrderID,CompanyID,MemberID,ProspectID,AffiliateID,PromotionID,PartyID,AddressID,OrderDate,Amount,Tax,Total,Status,
-- Notes,Discount,Shipping,Ship,IsTaxable,IsRecur,PinnDate,PinnAmount,CommDate,CommAmount,AutoShip,IsActive,BV,Track,Valid,UserID
	EXEC pts_SalesOrder_Add  @SalesOrderID OUTPUT, @CompanyID, @MemberID, 0,0,0,0,0,@PayDate, @Amount, 0, @Total, 1, 
		'', 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, '', 0, 1

	SET @Result = CAST(@SalesOrderID AS VARCHAR(20))

	SET @cnt = 1
	WHILE @cnt > 0
	BEGIN
		SET @tmpCode = ''
		IF @cnt = 1 BEGIN SET @tmpCode = '101' SET @ProductID = 89 END
		IF @cnt = 2 BEGIN SET @tmpCode = '102' SET @ProductID = 90 END
		IF @cnt = 3 BEGIN SET @tmpCode = '103' SET @ProductID = 91 END
		IF @cnt = 4 BEGIN SET @tmpCode = '104' SET @ProductID = 378 END
		IF @cnt = 5 BEGIN SET @tmpCode = '201' SET @ProductID = 92 END
		IF @cnt = 6 BEGIN SET @tmpCode = '202' SET @ProductID = 286 END
		IF @cnt = 7 BEGIN SET @tmpCode = '203' SET @ProductID = 93 END
		IF @cnt = 8 BEGIN SET @tmpCode = '205' SET @ProductID = 379 END
		IF @cnt = 9 BEGIN SET @tmpCode = '211' SET @ProductID = 105 END
		IF @cnt = 10 BEGIN SET @tmpCode = '212' SET @ProductID = 287 END
		IF @cnt = 11 BEGIN SET @tmpCode = '213' SET @ProductID = 106 END
		SET @cnt = @cnt + 1
		
		IF @tmpCode = ''
			SET @cnt = 0
		ELSE
		BEGIN
			IF CHARINDEX(@tmpCode, @Purpose) > 0 
			BEGIN
				IF @tmpCode NOT IN ('104','205') SET @tmpAmount = @Amount1 ELSE SET @tmpAmount = @Amount2
--				SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
				EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @tmpAmount, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
			END	
		END
	END

	UPDATE Payment SET OwnerType = 52, OwnerID = @SalesOrderID WHERE PaymentID = @PaymentID
END

GO 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        