EXEC [dbo].pts_CheckProc 'pts_Nexxus_UpgradeOrder'
GO

--declare @Result varchar(1000) EXEC pts_Nexxus_UpgradeOrder 7166, @Result output print @Result

CREATE PROCEDURE [dbo].pts_Nexxus_UpgradeOrder
   @MemberID int ,
   @Result varchar(1000) OUTPUT
AS

SET NOCOUNT ON
SET @Result = '0'

DECLARE @CompanyID int, @Title int, @Options2 varchar(40), @Wallet money, @Price money, @Price2 money, @Code varchar(3)
DECLARE @PayoutID int, @PaymentID int, @Today datetime, @Reference varchar(40), @cnt int
SET @CompanyID = 21
SET @Today = dbo.wtfn_DateOnly( GETDATE())

-- *******************************************************************
--  Check if this member's Order can be Upgraded
-- *******************************************************************

-- Get member's title and options
SELECT @Title = Title, @Options2 = Options2 FROM Member WHERE MemberID = @MemberID

-- Get Wallet Balance
SELECT @Wallet = ISNULL(SUM(Amount),0) FROM Payout WHERE OwnerType = 4 AND OwnerID = @MemberID AND Status IN (1,4,5,7) AND Show = 0

SET @Price = 0
SET @Code = ''
IF CHARINDEX(@Options2, '101') > 0 BEGIN SET @Price = 10 SET @Code = '101' END
IF CHARINDEX(@Options2, '102') > 0 BEGIN SET @Price = 25 SET @Code = '102' END
IF CHARINDEX(@Options2, '103') > 0 BEGIN SET @Price = 50 SET @Code = '103' END
IF CHARINDEX(@Options2, '106') > 0 BEGIN SET @Price = 10 SET @Code = '106' END
IF CHARINDEX(@Options2, '107') > 0 BEGIN SET @Price = 25 SET @Code = '107' END
IF CHARINDEX(@Options2, '108') > 0 BEGIN SET @Price = 50 SET @Code = '108' END

-- Can't Upgrade to $10 for 1-3 Star Affiliate Ranks (@Title >= 3 AND @Title <= 5)

--Diamond, 2 Diamond Ranks
IF @Title >= 6 AND @Title <= 7 AND @Price < 25 AND @Wallet >= 25 AND @Code != ''
BEGIN
	--Upgrade Auto Order
	SET @Price = 25
	SET @Options2 = REPLACE(@Options2,@Code, '')
	SET @Options2 = REPLACE(@Options2,',', '')
	IF @Code = '101' SET @Code = '102'
	IF @Code = '106' SET @Code = '107'
	SET @Options2 = @Options2 + ',' + @Code
	SET @Result = '1'
END 
 
-- 3 Diamond and up Ranks
IF @Title >= 8 AND @Price < 50 AND @Wallet >= 50 AND @Code != ''
BEGIN
	--Upgrade Auto Order
	SET @Price = 50
	SET @Options2 = REPLACE(@Options2,@Code, '')
	SET @Options2 = REPLACE(@Options2,',', '')
	IF @Code IN ('101','102') SET @Code = '103'
	IF @Code IN ('106','107') SET @Code = '108'
	SET @Options2 = @Options2 + ',' + @Code
	SET @Result = '1'	
END	

IF @Result = '1'
BEGIN
-- Create Payout
	SET @Price2 = @Price * -1
--  PayoutID,CompanyID,OwnerType,OwnerID,PayDate,PaidDate,Amount,Status,Notes,PayType,Reference,Show,UserID
	EXEC pts_Payout_Add @PayoutID OUTPUT, @CompanyID, 4, @MemberID, @Today, @Today, @Price2, 1, 'Order Upgrade', 5, '', 0, 1  

-- Create Payment
	SET @Reference = CAST(@PayoutID AS VARCHAR(10))
--  PaymentID,CompanyID,OwnerType,OwnerID,BillingID,ProductID,PaidID,PayDate,PaidDate,PayType,Amount,Total,Credit,Retail,Commission,
--  Description,Purpose,Status,Reference,Notes,CommStatus,CommDate,TokenType,TokenOwner,Token,UserID
	EXEC pts_Payment_Add @PaymentID OUTPUT, @CompanyID, 4, @MemberID, 0, 0, 0, @Today, @Today, 90, @Price, @Price, 0, 0, 0,
   'Order Upgrade', @Code, 3, @Reference, '', 1, 0, 0, 0, 0, 1

--	Update Payout Reference
	UPDATE Payout SET Reference = CAST(@PaymentID AS VARCHAR(10)) WHERE PayoutID = @PayoutID

--	Do Payment post processing
	EXEC pts_Nexxus_PaymentPost @PaymentID, @cnt OUTPUT
	
-- Update Member Auto-Order Option
	SET @Today = DATEADD( m, 1, @Today)
	UPDATE Member SET Price = @Price, Options2 = @Options2, PaidDate = @Today WHERE MemberID = @MemberID
END

GO 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        