EXEC [dbo].pts_CheckProc 'pts_SilverHeart_ConvertPayment'
GO

--declare @Result varchar(1000) EXEC pts_SilverHeart_ConvertPayment 28917, @Result output print @Result

CREATE PROCEDURE [dbo].pts_SilverHeart_ConvertPayment
   @PaymentID int ,
   @Result varchar(1000) OUTPUT
AS

SET NOCOUNT ON

DECLARE @SalesOrderID int, @ID int, @CompanyID int, @MemberID int, @Total money, @Purpose varchar(100), @PayDate datetime 
DECLARE @Amount money, @Amount1 money, @Amount2 money, @Shipping money, @ProductID int, @tmpPaymentID int, @CountryID int
DECLARE @Ship1 money, @Ship3 money, @tmpCode varchar(10), @cnt int

SET @Result = '0'
SET @CompanyID = 20
SET @Amount = 0
SET @Amount1 = 0
SET @Amount2 = 0
SET @Shipping = 0
SET @CountryID = 224

SET @tmpPaymentID = @PaymentID
SET @PaymentID = -1
SELECT @PaymentID = ISNULL(PaymentID,0), @MemberID = OwnerID, @Purpose = Purpose, @PayDate = PayDate FROM Payment Where PaymentID = @tmpPaymentID AND OwnerType = 4 AND Status >= 1 AND Status <= 3
SELECT @CountryID = CountryID FROM Address WHERE OwnerType = 4 AND OwnerID = @MemberID AND AddressType = 2 AND IsActive != 0

IF @PaymentID > 0
BEGIN
	IF @Purpose Like 'AUTO:%' EXEC pts_SilverHeart_ValidAutoShip @Purpose, @Purpose OUTPUT

	SET @cnt = 1
	WHILE @cnt > 0
	BEGIN
		SET @tmpCode = ''
		IF @cnt = 1 SET @tmpCode = '101'
		IF @cnt = 2 SET @tmpCode = '102'
		IF @cnt = 3 SET @tmpCode = '103'
		IF @cnt = 3 SET @tmpCode = '104'
		SET @cnt = @cnt + 1
		
		IF @tmpCode = ''
			SET @cnt = 0
		ELSE
		BEGIN
			IF CHARINDEX(@tmpCode, @Purpose) > 0 
			BEGIN 
				SELECT @Amount = Price, @Ship1 = Ship1, @Ship3 = Ship3 FROM Product WHERE CompanyID = @CompanyID AND Code = @tmpCode
				IF @CountryID = 224 SET @Shipping = @Ship1 ELSE SET @Shipping = @Ship3 
			END	
		END
	END

	SET @Total = @Amount + @Shipping

-- SalesOrderID,CompanyID,MemberID,ProspectID,AffiliateID,PromotionID,PartyID,AddressID,OrderDate,Amount,Tax,Total,Status,
-- Notes,Discount,Shipping,Ship,IsTaxable,IsRecur,PinnDate,PinnAmount,CommDate,CommAmount,AutoShip,IsActive,BV,Track,Valid,UserID
	EXEC pts_SalesOrder_Add  @SalesOrderID OUTPUT, @CompanyID, @MemberID, 0,0,0,0,0,@PayDate, @Amount, 0, @Total, 1, 
		'', 0, @Shipping, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, '', 0, 1

	SET @Result = CAST(@SalesOrderID AS VARCHAR(20))

	SET @cnt = 1
	WHILE @cnt > 0
	BEGIN
		SET @tmpCode = ''
		IF @cnt = 1 BEGIN SET @tmpCode = '101' SET @ProductID = 460 END
		IF @cnt = 2 BEGIN SET @tmpCode = '102' SET @ProductID = 464 END
		IF @cnt = 3 BEGIN SET @tmpCode = '103' SET @ProductID = 461 END
		IF @cnt = 3 BEGIN SET @tmpCode = '104' SET @ProductID = 462 END
		SET @cnt = @cnt + 1
		
		IF @tmpCode = ''
			SET @cnt = 0
		ELSE
		BEGIN
			IF CHARINDEX(@tmpCode, @Purpose) > 0 
			BEGIN
--				SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
				EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @Amount, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
			END	
		END
	END

	UPDATE Payment SET OwnerType = 52, OwnerID = @SalesOrderID WHERE PaymentID = @PaymentID
END

GO 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        