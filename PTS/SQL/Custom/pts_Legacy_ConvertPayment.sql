EXEC [dbo].pts_CheckProc 'pts_Legacy_ConvertPayment'
GO

--declare @Result varchar(1000) EXEC pts_Legacy_ConvertPayment 28917, @Result output print @Result

CREATE PROCEDURE [dbo].pts_Legacy_ConvertPayment
   @PaymentID int ,
   @Result varchar(1000) OUTPUT
AS

SET NOCOUNT ON

DECLARE @SalesOrderID int, @ID int, @CompanyID int, @MemberID int, @Total money, @Purpose varchar(100), @PayDate datetime 
DECLARE @Amount money, @Amount1 money, @Amount2 money, @Shipping money, @ProductID int, @tmpPaymentID int, @CountryID int
DECLARE @Ship1 money, @Ship3 money, @tmpCode varchar(10), @cnt int

SET @Result = '0'
SET @CompanyID = 14
SET @Amount = 0
SET @Amount1 = 0
SET @Amount2 = 0
SET @Shipping = 0
SET @CountryID = 224

SET @tmpPaymentID = @PaymentID
SET @PaymentID = -1
SELECT @PaymentID = ISNULL(PaymentID,0), @MemberID = OwnerID, @Purpose = Purpose, @PayDate = PayDate FROM Payment Where PaymentID = @tmpPaymentID AND OwnerType = 4 AND Status >= 1 AND Status <= 3
SELECT @CountryID = CountryID FROM Address WHERE OwnerType = 4 AND OwnerID = @MemberID AND AddressType = 2 AND IsActive != 0

IF @PaymentID > 0
BEGIN
	IF @Purpose Like 'AUTO:%' EXEC pts_Legacy_ValidAutoShip @Purpose, @Purpose OUTPUT

	SET @cnt = 1
	WHILE @cnt > 0
	BEGIN
		SET @tmpCode = ''
		IF @cnt = 1 SET @tmpCode = '100'
		IF @cnt = 2 SET @tmpCode = '101'
		IF @cnt = 3 SET @tmpCode = '102'
		IF @cnt = 4 SET @tmpCode = '103'
		IF @cnt = 5 SET @tmpCode = '104'
		IF @cnt = 6 SET @tmpCode = '105'
		IF @cnt = 7 SET @tmpCode = '106'
		IF @cnt = 8 SET @tmpCode = '107'
		IF @cnt = 9 SET @tmpCode = '108'
		IF @cnt = 10 SET @tmpCode = '109'
		IF @cnt = 11 SET @tmpCode = '110'
		IF @cnt = 12 SET @tmpCode = '111'
		IF @cnt = 13 SET @tmpCode = '112'
		IF @cnt = 14 SET @tmpCode = '113'
		IF @cnt = 15 SET @tmpCode = '114'
		IF @cnt = 16 SET @tmpCode = '115'
		IF @cnt = 17 SET @tmpCode = '116'
		IF @cnt = 18 SET @tmpCode = '117'
		IF @cnt = 19 SET @tmpCode = '118'
		IF @cnt = 20 SET @tmpCode = '119'
		IF @cnt = 21 SET @tmpCode = '120'
		IF @cnt = 22 SET @tmpCode = '121'
		IF @cnt = 23 SET @tmpCode = '122'
		IF @cnt = 24 SET @tmpCode = '123'
		IF @cnt = 25 SET @tmpCode = '125'
		IF @cnt = 26 SET @tmpCode = '131'
		SET @cnt = @cnt + 1
		
		IF @tmpCode = ''
			SET @cnt = 0
		ELSE
		BEGIN
			IF CHARINDEX(@tmpCode, @Purpose) > 0 
			BEGIN 
				SELECT @Amount = Price, @Ship1 = Ship1, @Ship3 = Ship3 FROM Product WHERE CompanyID = @CompanyID AND Code = @tmpCode
				IF @CountryID = 224 SET @Shipping = @Ship1 ELSE SET @Shipping = @Ship3 
				IF @tmpCode IN ( '103', '122', '123' ) SET @Amount2 = @Amount ELSE SET @Amount1 = @Amount
			END	
		END
	END

	SET @Amount = @Amount1 + @Amount2
	SET @Total = @Amount + @Shipping

-- SalesOrderID,CompanyID,MemberID,ProspectID,AffiliateID,PromotionID,PartyID,AddressID,OrderDate,Amount,Tax,Total,Status,
-- Notes,Discount,Shipping,Ship,IsTaxable,IsRecur,PinnDate,PinnAmount,CommDate,CommAmount,AutoShip,IsActive,BV,Track,Valid,UserID
	EXEC pts_SalesOrder_Add  @SalesOrderID OUTPUT, @CompanyID, @MemberID, 0,0,0,0,0,@PayDate, @Amount, 0, @Total, 1, 
		'', 0, @Shipping, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, '', 0, 1

	SET @Result = CAST(@SalesOrderID AS VARCHAR(20))

	SET @cnt = 1
	WHILE @cnt > 0
	BEGIN
		SET @tmpCode = ''
		IF @cnt = 1 BEGIN SET @tmpCode = '100' SET @ProductID = 430 END
		IF @cnt = 2 BEGIN SET @tmpCode = '101' SET @ProductID = 356 END
		IF @cnt = 3 BEGIN SET @tmpCode = '102' SET @ProductID = 184 END
		IF @cnt = 4 BEGIN SET @tmpCode = '103' SET @ProductID = 185 END
		IF @cnt = 5 BEGIN SET @tmpCode = '104' SET @ProductID = 186 END
		IF @cnt = 6 BEGIN SET @tmpCode = '105' SET @ProductID = 187 END
		IF @cnt = 7 BEGIN SET @tmpCode = '106' SET @ProductID = 188 END
		IF @cnt = 8 BEGIN SET @tmpCode = '107' SET @ProductID = 189 END
		IF @cnt = 9 BEGIN SET @tmpCode = '108' SET @ProductID = 190 END
		IF @cnt = 10 BEGIN SET @tmpCode = '109' SET @ProductID = 258 END
		IF @cnt = 11 BEGIN SET @tmpCode = '110' SET @ProductID = 283 END
		IF @cnt = 12 BEGIN SET @tmpCode = '111' SET @ProductID = 192 END
		IF @cnt = 13 BEGIN SET @tmpCode = '112' SET @ProductID = 193 END
		IF @cnt = 14 BEGIN SET @tmpCode = '113' SET @ProductID = 194 END
		IF @cnt = 15 BEGIN SET @tmpCode = '114' SET @ProductID = 195 END
		IF @cnt = 16 BEGIN SET @tmpCode = '115' SET @ProductID = 196 END
		IF @cnt = 17 BEGIN SET @tmpCode = '116' SET @ProductID = 197 END
		IF @cnt = 18 BEGIN SET @tmpCode = '117' SET @ProductID = 198 END
		IF @cnt = 19 BEGIN SET @tmpCode = '118' SET @ProductID = 199 END
		IF @cnt = 20 BEGIN SET @tmpCode = '119' SET @ProductID = 200 END
		IF @cnt = 21 BEGIN SET @tmpCode = '120' SET @ProductID = 201 END
		IF @cnt = 22 BEGIN SET @tmpCode = '121' SET @ProductID = 202 END
		IF @cnt = 23 BEGIN SET @tmpCode = '122' SET @ProductID = 476 END
		IF @cnt = 24 BEGIN SET @tmpCode = '123' SET @ProductID = 477 END
		IF @cnt = 25 BEGIN SET @tmpCode = '125' SET @ProductID = 275 END
		IF @cnt = 26 BEGIN SET @tmpCode = '131' SET @ProductID = 191 END
		SET @cnt = @cnt + 1
		
		IF @tmpCode = ''
			SET @cnt = 0
		ELSE
		BEGIN
			IF CHARINDEX(@tmpCode, @Purpose) > 0 
			BEGIN
				IF @tmpCode IN ( '103', '122', '123' ) SET @Amount = @Amount2 ELSE SET @Amount = @Amount1 
--				SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
				EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @Amount, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
			END	
		END
	END

	UPDATE Payment SET OwnerType = 52, OwnerID = @SalesOrderID WHERE PaymentID = @PaymentID
END

GO 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        