EXEC [dbo].pts_CheckProc 'pts_ZaZZed_ConvertPayment'
GO

--declare @Result varchar(1000) EXEC pts_ZaZZed_ConvertPayment 7211, @Result output print @Result

CREATE PROCEDURE [dbo].pts_ZaZZed_ConvertPayment
   @PaymentID int ,
   @Result varchar(1000) OUTPUT
AS

SET NOCOUNT ON

DECLARE @SalesOrderID int, @ID int, @CompanyID int, @MemberID int, @Total money, @Purpose varchar(100), @PayDate datetime 
DECLARE @Amount money, @Amount1 money, @Amount2 money, @Shipping money, @ProductID int, @tmpPaymentID int, @CountryID int

SET @Result = '0'
SET @CompanyID = 9
SET @Amount = 0
SET @Amount1 = 0
SET @Amount2 = 0
SET @Shipping = 7
SET @CountryID = 224

SET @tmpPaymentID = @PaymentID
SET @PaymentID = -1
SELECT @PaymentID = ISNULL(PaymentID,0), @MemberID = OwnerID, @Purpose = Purpose, @PayDate = PayDate FROM Payment Where PaymentID = @tmpPaymentID AND OwnerType = 4 AND Status >= 1 AND Status <= 3
SELECT @CountryID = CountryID FROM Address WHERE OwnerType = 4 AND OwnerID = @MemberID AND AddressType = 2 AND IsActive != 0

IF @PaymentID > 0
BEGIN
	IF CHARINDEX('115,116', @Purpose) > 0
	BEGIN
		SELECT @Amount1 = Price FROM Product WHERE CompanyID = 9 AND Code = 115
		IF @CountryID != 224 SET @Shipping = 12
	END	
	ELSE	
	BEGIN
		IF CHARINDEX('116', @Purpose) > 0 SELECT @Amount1 = Price FROM Product WHERE CompanyID = 9 AND Code = 116
		IF @CountryID != 224 SET @Shipping = 10
	END	
	
	IF CHARINDEX('101', @Purpose) > 0 
	BEGIN 
		SELECT @Amount1 = Price FROM Product WHERE CompanyID = 9 AND Code = 101
		IF @CountryID != 224 SET @Shipping = 10
	END	
	IF CHARINDEX('102', @Purpose) > 0 
	BEGIN 
		SELECT @Amount1 = Price FROM Product WHERE CompanyID = 9 AND Code = 102
		IF @CountryID != 224 SET @Shipping = 10
	END	
	IF CHARINDEX('201', @Purpose) > 0 
	BEGIN 
		SELECT @Amount2 = Price FROM Product WHERE CompanyID = 9 AND Code = 201
		SET @Shipping = 0
	END	
	IF CHARINDEX('303', @Purpose) > 0 
	BEGIN 
		SELECT @Amount1 = Price FROM Product WHERE CompanyID = 9 AND Code = 303
		SET @Shipping = 0
	END	

	SET @Amount = @Amount1 + @Amount2
	SET @Total = @Amount + @Shipping

-- SalesOrderID,CompanyID,MemberID,ProspectID,AffiliateID,PromotionID,PartyID,AddressID,OrderDate,Amount,Tax,Total,Status,
-- Notes,Discount,Shipping,Ship,IsTaxable,IsRecur,PinnDate,PinnAmount,CommDate,CommAmount,AutoShip,IsActive,BV,Track,Valid,UserID
	EXEC pts_SalesOrder_Add  @SalesOrderID OUTPUT, @CompanyID, @MemberID, 0,0,0,0,0,@PayDate, @Amount, 0, @Total, 1, 
		'', 0, @Shipping, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, '', 0, 1

	SET @Result = CAST(@SalesOrderID AS VARCHAR(20))

	IF CHARINDEX('115,116', @Purpose) > 0
	BEGIN
		SET @ProductID = 75
--		SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
		EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @Amount1, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
	END	
	ELSE	
	BEGIN
		IF CHARINDEX('116', @Purpose) > 0
		BEGIN
			SET @ProductID = 77
--			SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
			EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @Amount1, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
		END	
	END	
	IF CHARINDEX('101', @Purpose) > 0
	BEGIN
		SET @ProductID = 57
--		SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
		EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @Amount1, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
	END
	IF CHARINDEX('102', @Purpose) > 0
	BEGIN
		SET @ProductID = 62
--		SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
		EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @Amount1, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
	END
	IF CHARINDEX('201', @Purpose) > 0
	BEGIN
		SET @ProductID = 59
--		SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
		EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @Amount2, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
	END
	IF CHARINDEX('303', @Purpose) > 0
	BEGIN
		SET @ProductID = 82
--		SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
		EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @Amount1, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
	END

	UPDATE Payment SET OwnerType = 52, OwnerID = @SalesOrderID WHERE PaymentID = @PaymentID
END

GO 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        