EXEC [dbo].pts_CheckProc 'pts_GFTG_ConvertPayment'
GO

--declare @Result varchar(1000) EXEC pts_GFTG_ConvertPayment 26481, @Result output print @Result

CREATE PROCEDURE [dbo].pts_GFTG_ConvertPayment
   @PaymentID int ,
   @Result varchar(1000) OUTPUT
AS

SET NOCOUNT ON

DECLARE @SalesOrderID int, @ID int, @CompanyID int, @MemberID int, @Total money, @Purpose varchar(100), @PayDate datetime 
DECLARE @Amount money, @Amount1 money, @Amount2 money, @Shipping money, @ProductID int, @tmpPaymentID int, @CountryID int
DECLARE @Ship1 money, @Ship3 money, @tmpCode varchar(10), @cnt int

SET @Result = '0'
SET @CompanyID = 13
SET @Amount = 0
SET @Amount1 = 0
SET @Amount2 = 0
SET @Shipping = 0
SET @CountryID = 224

SET @tmpPaymentID = @PaymentID
SET @PaymentID = -1
SELECT @PaymentID = ISNULL(PaymentID,0), @MemberID = OwnerID, @Purpose = Purpose, @PayDate = PayDate FROM Payment Where PaymentID = @tmpPaymentID AND OwnerType = 4 AND Status >= 1 AND Status <= 3
SELECT @CountryID = CountryID FROM Address WHERE OwnerType = 4 AND OwnerID = @MemberID AND AddressType = 2 AND IsActive != 0

IF @PaymentID > 0
BEGIN
	SET @cnt = 1
	WHILE @cnt > 0
	BEGIN
		SET @tmpCode = ''
		IF @cnt = 1 SET @tmpCode = '101'
		IF @cnt = 2 SET @tmpCode = '102'
		IF @cnt = 3 SET @tmpCode = '103'
		IF @cnt = 4 SET @tmpCode = '104'
		IF @cnt = 5 SET @tmpCode = '105'
		IF @cnt = 6 SET @tmpCode = '106'
		IF @cnt = 7 SET @tmpCode = '107'
		IF @cnt = 8 SET @tmpCode = '108'
		IF @cnt = 9 SET @tmpCode = '109'
		IF @cnt = 10 SET @tmpCode = '110'
		IF @cnt = 11 SET @tmpCode = '111'
		IF @cnt = 12 SET @tmpCode = '121'
		IF @cnt = 13 SET @tmpCode = '122'
		IF @cnt = 14 SET @tmpCode = '123'
		IF @cnt = 15 SET @tmpCode = '124'
		IF @cnt = 16 SET @tmpCode = '125'
		IF @cnt = 17 SET @tmpCode = '126'

		IF @cnt = 18 SET @tmpCode = '224'
		IF @cnt = 19 SET @tmpCode = '225'
		IF @cnt = 20 SET @tmpCode = '226'
		IF @cnt = 21 SET @tmpCode = '227'
		IF @cnt = 22 SET @tmpCode = '228'
		IF @cnt = 23 SET @tmpCode = '229'
		IF @cnt = 24 SET @tmpCode = '221'

		IF @cnt = 25 SET @tmpCode = '334'
		IF @cnt = 26 SET @tmpCode = '335'
		IF @cnt = 27 SET @tmpCode = '336'
		IF @cnt = 28 SET @tmpCode = '337'
		IF @cnt = 29 SET @tmpCode = '338'
		IF @cnt = 30 SET @tmpCode = '339'
		IF @cnt = 31 SET @tmpCode = '331'

		SET @cnt = @cnt + 1
		
		IF @tmpCode = ''
			SET @cnt = 0
		ELSE
		BEGIN
			IF CHARINDEX(@tmpCode, @Purpose) > 0 
			BEGIN 
				SELECT @Amount1 = Price, @Ship1 = Ship1, @Ship3 = Ship3 FROM Product WHERE CompanyID = @CompanyID AND Code = @tmpCode
				IF @CountryID = 224 SET @Shipping = @Ship1 ELSE SET @Shipping = @Ship3 
			END	
		END
	END

	SET @Amount = @Amount1
	SET @Total = @Amount + @Shipping

-- SalesOrderID,CompanyID,MemberID,ProspectID,AffiliateID,PromotionID,PartyID,AddressID,OrderDate,Amount,Tax,Total,Status,
-- Notes,Discount,Shipping,Ship,IsTaxable,IsRecur,PinnDate,PinnAmount,CommDate,CommAmount,AutoShip,IsActive,BV,Track,Valid,UserID
	EXEC pts_SalesOrder_Add  @SalesOrderID OUTPUT, @CompanyID, @MemberID, 0,0,0,0,0,@PayDate, @Amount, 0, @Total, 1, 
		'', 0, @Shipping, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, '', 0, 1

	SET @Result = CAST(@SalesOrderID AS VARCHAR(20))

	SET @cnt = 1
	WHILE @cnt > 0
	BEGIN
		SET @tmpCode = ''
		IF @cnt = 1 BEGIN SET @tmpCode = '101' SET @ProductID = 149 END
		IF @cnt = 2 BEGIN SET @tmpCode = '102' SET @ProductID = 141 END
		IF @cnt = 3 BEGIN SET @tmpCode = '103' SET @ProductID = 142 END
		IF @cnt = 4 BEGIN SET @tmpCode = '104' SET @ProductID = 157 END
		IF @cnt = 5 BEGIN SET @tmpCode = '105' SET @ProductID = 164 END
		IF @cnt = 6 BEGIN SET @tmpCode = '106' SET @ProductID = 165 END
		IF @cnt = 7 BEGIN SET @tmpCode = '107' SET @ProductID = 167 END
		IF @cnt = 8 BEGIN SET @tmpCode = '108' SET @ProductID = 168 END
		IF @cnt = 9 BEGIN SET @tmpCode = '109' SET @ProductID = 169 END
		IF @cnt = 10 BEGIN SET @tmpCode = '110' SET @ProductID = 150 END
		IF @cnt = 11 BEGIN SET @tmpCode = '111' SET @ProductID = 217 END
		IF @cnt = 12 BEGIN SET @tmpCode = '121' SET @ProductID = 151 END
		IF @cnt = 13 BEGIN SET @tmpCode = '122' SET @ProductID = 152 END
		IF @cnt = 14 BEGIN SET @tmpCode = '123' SET @ProductID = 153 END
		IF @cnt = 15 BEGIN SET @tmpCode = '124' SET @ProductID = 154 END
		IF @cnt = 16 BEGIN SET @tmpCode = '125' SET @ProductID = 155 END
		IF @cnt = 17 BEGIN SET @tmpCode = '126' SET @ProductID = 156 END

		IF @cnt = 18 BEGIN SET @tmpCode = '224' SET @ProductID = 263 END
		IF @cnt = 19 BEGIN SET @tmpCode = '225' SET @ProductID = 261 END
		IF @cnt = 20 BEGIN SET @tmpCode = '226' SET @ProductID = 260 END
		IF @cnt = 21 BEGIN SET @tmpCode = '227' SET @ProductID = 262 END
		IF @cnt = 22 BEGIN SET @tmpCode = '228' SET @ProductID = 259 END
		IF @cnt = 23 BEGIN SET @tmpCode = '229' SET @ProductID = 264 END
		IF @cnt = 24 BEGIN SET @tmpCode = '221' SET @ProductID = 265 END

		IF @cnt = 25 BEGIN SET @tmpCode = '334' SET @ProductID = 266 END
		IF @cnt = 26 BEGIN SET @tmpCode = '335' SET @ProductID = 267 END
		IF @cnt = 27 BEGIN SET @tmpCode = '336' SET @ProductID = 268 END
		IF @cnt = 28 BEGIN SET @tmpCode = '337' SET @ProductID = 269 END
		IF @cnt = 29 BEGIN SET @tmpCode = '338' SET @ProductID = 270 END
		IF @cnt = 30 BEGIN SET @tmpCode = '339' SET @ProductID = 271 END
		IF @cnt = 31 BEGIN SET @tmpCode = '331' SET @ProductID = 272 END

		SET @cnt = @cnt + 1
		
		IF @tmpCode = ''
			SET @cnt = 0
		ELSE
		BEGIN
			IF CHARINDEX(@tmpCode, @Purpose) > 0 
			BEGIN
--				SalesItemID,SalesOrderID,ProductID,Quantity,Price,OptionPrice,Tax,InputValues,Reference,Status,BillDate,EndDate,Locks,BV,Valid,UserID
				EXEC pts_SalesItem_Add @ID, @SalesOrderID, @ProductID, 1, @Amount1, 0, 0, '', '', 1, 0, 0, 0, 0, 0, 1
			END	
		END
	END

	UPDATE Payment SET OwnerType = 52, OwnerID = @SalesOrderID WHERE PaymentID = @PaymentID
END

GO 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        